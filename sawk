#!/bin/sh

lint() {
	gawk --posix "--lint$fatal" -f "${1--}" >/dev/null
}

link() {
	awk '/^#include/ {
		gsub(/"/, "", $2)

		while ((getline x < $2) > 0)
			print x

		next
	}

	{
		print
	}' "$@"
}

usage() {
	echo "usage: sawk [-dmv] [file]" >&2
	exit 1
}

set -eu

fatal="=fatal"
while getopts "mv" c; do
	case "$c" in
	d) set -x ;;
	m) fatal="" ;;
	v) echo "sawk v0.0.1" && exit ;;
	*) usage ;;
	esac
done
shift $((OPTIND - 1))

[ "$#" -ne 1 ] && usage

linked="$(link "$1")"

echo "$linked" | lint -

echo "$linked" | ./awkfmt
